---
title: "Análisis Estadístico de las Finanzas Públicas Estatales en México: Egresos"
subtitle: "Análisis de Componentes Principales"
author: "Heidi Idali Pacheco Almaraz"
format: 
  html:
    grid: 
      body-width: 1000px
editor: visual
---

```{=html}
<style>
main.content {
text-align: justify}
</style>
```

```{r}
#| code-fold: true
#| message: false
#| warning: false

library(tidyverse)
library(RColorBrewer)
library(sf)          # Para datos espaciales
library(viridis)     # Para paletas de colores
library(DT)
library(plotly)
library(knitr)
library(kableExtra)
library(corrplot)
library(broom)
library(scales)
library(multcomp)


library(factoextra)
library(FactoMineR)
```

# Introducción 

Previamente se hizo una descripción general de los egresos estatales de México utilizando la base de datos de EFIPEM. 
En este documento, se llevará a cabo el desglose de los egresos por capítulos encontrando los componentes principales, que son proyecciones ortogonales sobre el espacio vectorial generado por los datos. 

## Estructura General de los Datos

-   Dataset `egresos`: Filtrado para el tema "Egresos" y categoría "Capítulo". Se agrega porcentaje anual de cada capitulo.
-   Dataset `egresos_agregados`: Agreado por año, estado y categoría principal con cálculos de porcentaje anual.
-   Dataset `egresos_wide`: Transformando a formato ancho con valores y porcentajes por categoría principal.

Consideramos los datos de finanzas públicas de los estado de México disponibles en varios archivos CSV dentro de la carpeta "conjunto_de_datos". No se consideran los valores de la Ciudad de México. 

```{r}
#| code-fold: true
#| message: false
#| warning: false


# Se identifican los archivos CSV en el directorio especificado
data_sets <- list.files("./conjunto_de_datos", pattern = "*.csv", full.names = TRUE)

# Se leen y combinan los archivos CSV en un solo data frame
datos <- data_sets |> 
  set_names(nm = data_sets) |> 
  map_dfr(read_csv, .id = "source_file")

# Convertir variables de tipo character a factor
datos_factor <- datos |> 
  dplyr::select(where(is.character)) |> 
  names()

datos <- datos |> 
  mutate(across(all_of(datos_factor), as_factor))

# Crear variables adicionales
datos <- datos |> mutate(ANIO_factor = as_factor(ANIO), VALOR_millones = VALOR / 1e6)
datos <- datos |> rename(CVE_ENT = ID_ENTIDAD)

# Cargar datos de estados y unir con el conjunto de datos principal
datos_estado <- read_csv("tc_entidad.csv")
datos_estado <- datos_estado |> mutate(across(everything(), as_factor))
datos_estado$ZONA <- factor(datos_estado$ZONA, levels = c("NORTE", "CENTRO", "SUR"))

datos <- left_join(datos, datos_estado)

# Eliminar columnas no necesarias
datos <- datos |> dplyr::select(-source_file, -PROD_EST, -COBERTURA, -ESTATUS) 

#glimpse(datos)
nacional_estado <- st_read("data_nacional/00ent.shp", options = "ENCODING=LATIN1", quiet = TRUE)
nacional_estado <- left_join(nacional_estado, datos_estado, by = "CVE_ENT")

cat("Años disponibles:", paste(unique(datos$ANIO_factor), collapse = ", "), "\n")
cat("Entidades incluidas:", length(unique(datos$CVE_ENT)), "\n")
cat("Temas:", paste(unique(datos$TEMA), collapse = ", "), "\n")
cat("Categorías:", paste(unique(datos$CATEGORIA), collapse = ", "), "\n\n")
```

```{r}
#| code-fold: true

# Filtrar datos de egresos a nivel capítulo
egresos <- datos |> filter(TEMA == "Egresos", CATEGORIA == "Capítulo")

# Agregar porcentaje anual al dataset original
egresos <- egresos |> 
  group_by(ANIO, CVE_ENT, NOM_ENT) |> 
  mutate(
    valor_estado_anio = sum(VALOR_millones, na.rm = TRUE),
    porcentaje_anual = (VALOR_millones / valor_estado_anio) * 100
  ) |> 
  ungroup()

# Definir niveles de categoría para egresos
niveles_categoria_egresos <- c("Servicios personales",
                               "Materiales y suministros",
                               "Servicios generales",
                               "Transferencias, asignaciones, subsidios y otras ayudas",
                               "Obras públicas y acciones sociales",
                               "Bienes muebles, inmuebles e intangibles", "Inversión pública",
                               "Inversiones financieras y otras provisiones", "Recursos asignados a municipios",
                               "Otros egresos", 
                               "Deuda pública", 
                               "Disponibilidad final")

egresos$DESCRIPCION_CATEGORIA <- factor(egresos$DESCRIPCION_CATEGORIA, 
                                       levels = niveles_categoria_egresos)

# Agregar columna de categorías principales para egresos
egresos <- egresos |> 
  mutate(
    CATEGORIA_PRINCIPAL = case_when(
      # Gasto Corriente
      DESCRIPCION_CATEGORIA %in% c("Servicios personales", 
                                   "Materiales y suministros",
                                   "Servicios generales",
                                   "Transferencias, asignaciones, subsidios y otras ayudas") ~ "Gasto Corriente",
      
      # Gasto Capital
      DESCRIPCION_CATEGORIA %in% c("Obras públicas y acciones sociales",
                                   "Bienes muebles, inmuebles e intangibles",
                                   "Inversión pública",
                                   "Inversiones financieras y otras provisiones") ~ "Gasto Capital",
      
      # Deuda Pública
      DESCRIPCION_CATEGORIA %in% c("Deuda pública") ~ "Deuda Pública",
      
      # Otros Egresos
      DESCRIPCION_CATEGORIA %in% c("Otros egresos", "Disponibilidad final") ~ "Otros Egresos"
    ),
    
    # Convertir a factor con orden específico
    CATEGORIA_PRINCIPAL = factor(CATEGORIA_PRINCIPAL, 
                                levels = c("Gasto Corriente",
                                           "Gasto Capital",
                                           "Deuda Pública",
                                           "Otros Egresos"))
  )


# Agregar datos por ANIO, Estado y CATEGORIA_PRINCIPAL con porcentajes
egresos_agregados <- egresos |> 
  group_by(ANIO, CVE_ENT, NOM_ENT, ABR_ENT, ZONA, CATEGORIA_PRINCIPAL, ANIO_factor) |> 
  summarise(
    VALOR = sum(VALOR, na.rm = TRUE),
    VALOR_millones = sum(VALOR_millones, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  # Calcular porcentaje por estado y año
  group_by(ANIO, CVE_ENT, NOM_ENT) |> 
  mutate(
    valor_estado_anio = sum(VALOR_millones, na.rm = TRUE),
    porcentaje_anual = (VALOR_millones / valor_estado_anio) * 100
  ) |> 
  ungroup() |> 
  # Reordenar columnas para mantener estructura similar
  dplyr::select(
    ANIO,
    CVE_ENT, 
    VALOR,
    ANIO_factor,
    VALOR_millones,
    porcentaje_anual,
    NOM_ENT,
    ABR_ENT,
    ZONA,
    CATEGORIA_PRINCIPAL
  )


# Transformar a formato ancho con valor y porcentaje por categoría
egresos_wide <- egresos_agregados |> 
  dplyr::select(ANIO, CVE_ENT, ANIO_factor, NOM_ENT, ABR_ENT, ZONA, 
         CATEGORIA_PRINCIPAL, VALOR_millones, porcentaje_anual) |> 
  pivot_wider(
    names_from = CATEGORIA_PRINCIPAL,
    values_from = c(VALOR_millones, porcentaje_anual),
    names_sep = "_"
  ) |> 
  rename_with(
    ~ case_when(
      .x == "VALOR_millones_Gasto Corriente" ~ "Gasto_Corriente_valor",
      .x == "porcentaje_anual_Gasto Corriente" ~ "Gasto_Corriente_porcentaje",
      .x == "VALOR_millones_Gasto Capital" ~ "Gasto_Capital_valor",
      .x == "porcentaje_anual_Gasto Capital" ~ "Gasto_Capital_porcentaje",
      .x == "VALOR_millones_Deuda Pública" ~ "Deuda_Publica_valor",
      .x == "porcentaje_anual_Deuda Pública" ~ "Deuda_Publica_porcentaje",
      .x == "VALOR_millones_Otros Egresos" ~ "Otros_Egresos_valor",
      .x == "porcentaje_anual_Otros Egresos" ~ "Otros_Egresos_porcentaje",
      TRUE ~ .x
    )
  ) |> 
  # Reemplazar NA con 0 donde sea apropiado
  mutate(
    across(contains("_valor"), ~ replace_na(.x, 0)),
    across(contains("_porcentaje"), ~ replace_na(.x, 0))
  ) |> 
  # Reordenar columnas
  dplyr::select(
    ANIO, CVE_ENT, ANIO_factor, NOM_ENT, ABR_ENT, ZONA,
    Gasto_Corriente_valor, Gasto_Corriente_porcentaje,
    Gasto_Capital_valor, Gasto_Capital_porcentaje,
    Deuda_Publica_valor, Deuda_Publica_porcentaje,
    Otros_Egresos_valor, Otros_Egresos_porcentaje
  )
```


Se seleccionan las variables numéricas para el análisis de componentes principales (PCA). En este caso, se utilizan los valores en millones de pesos y los respectivos porcentajes en conjuntos de datos separados.

```{r}
#| code-fold: true

egresos_wo_MEX <- egresos_wide |> filter(ABR_ENT != "MEX")


egresos_numeric_valor <- egresos_wo_MEX |> 
  dplyr::select(
    Gasto_Corriente_valor,
    Gasto_Capital_valor,
    Deuda_Publica_valor,
    Otros_Egresos_valor
  )

egresos_numeric_porcentaje <- egresos_wide |> 
  dplyr::select(
    Gasto_Corriente_porcentaje,
    Gasto_Capital_porcentaje,
    Deuda_Publica_porcentaje,
    Otros_Egresos_porcentaje
  )
```


# PCA en valores (millones de pesos)

:::: panel-tabset
## Eigenvalores y varianzas

```{r}
#| code-fold: true

PC_valor <- prcomp(egresos_numeric_valor, scale.=TRUE, center=TRUE)

eig_valor <- get_eigenvalue(PC_valor)
eig_tabla <- data.frame(PC=paste0("PC",1:dim(eig_valor)[1]), 
                        Eigenvalor=round(eig_valor$eigenvalue,3), 
                        Varianza=round(eig_valor$variance.percent,2), 
                        Var_acu=round(eig_valor$cumulative.variance.percent,2))

kable(eig_tabla, align = "c", col.names = c("Componente", "Eigenvalor", "% varianza", "% varianza acumulada")) %>% kable_styling(c("striped", "hover"), full_width = F)%>% scroll_box(width="100%", height="300px", fixed_thead = TRUE)
```

## Scree plot

```{r}
#| code-fold: true
#| warning: false

fviz_eig(PC_valor, addlabels = TRUE)
```

## Coeficientes (Loadings)

```{r}
#| code-fold: true
PC_coef <-data.frame(PC_valor$rotation)
kable(PC_coef, align = "c") %>% kable_styling(c("striped", "hover"), full_width = F)%>% scroll_box(width="100%", height="300px", fixed_thead = TRUE)
```


## Contribución variables

```{r}
#| code-fold: true
#| warning: false

fviz_pca_var(PC_valor, col.var = "contrib", gradient.cols=c("#1627dc", "#ffb600", "#ff2e16"))
```

Podemos observar que la **Deuda Publica** y **Otros Egresos** contribuyen significativamente en la dispersión de los datos de ambas dimensiones. Sin embargo, **Gasto Corriente** y **Gasto Capital** contribuyen en menor medida, lo que subraya que están más relacionadas entre sí y explican una menor parte de la variabilidad total. 

## Contribución PC1

```{r}
#| code-fold: true
fviz_contrib(PC_valor, "var", axes = 1)
```

## Contribución PC2

```{r}
#| code-fold: true
fviz_contrib(PC_valor, "var", axes = 2)
```

## Proyecciones

::: panel-tabset
### Biplot

```{r}
#| code-fold: true
fviz_pca_biplot(PC_valor,
                geom.ind = "point",
                fill.ind = egresos_wo_MEX$ABR_ENT,
                pointshape = 21 ,
                pointsize = 2,
                alpha.ind=0.6,
                col.var = "black",
                mean.point = FALSE,
                #palette= ,
                label= "var",
                repel = TRUE   
  )
```

La mayoria de las diferencias que observamos entre los estados podemos explicarla por los **Gastos Corrientes** y **Gastos Capital**, que están altamente correlacionados entre sí. Por otro lado, la **Deuda Pública** distingue a ciertos estados a lo largo de la segunda dimensión. Esto refleja que hay un comportamiento de egresos en los estados variado y que hay estados que sobresalen en deuda publica y pues marca las políticas gubernamentales que están siguiendo ahí.

### Proyección

```{r}
#| code-fold: true
proy_scores <- fviz_pca_ind(PC_valor,
             pointsize = 2,
             habillage = egresos_wo_MEX$ABR_ENT,
             mean.point = FALSE,
             label= "var",
            repel = TRUE 
  )
ggplotly(proy_scores)
```
:::
::::


# PCA en porcentajes

:::: panel-tabset
## Eigenvalores y varianzas

```{r}
#| code-fold: true

PC_porcentaje <- prcomp(egresos_numeric_porcentaje, scale.=TRUE, center=TRUE)

eig_porcentaje <- get_eigenvalue(PC_porcentaje)
eig_tabla <- data.frame(PC=paste0("PC",1:dim(eig_porcentaje)[1]), 
                        Eigenvalor=round(eig_porcentaje$eigenvalue,3), 
                        Varianza=round(eig_porcentaje$variance.percent,2), 
                        Var_acu=round(eig_porcentaje$cumulative.variance.percent,2))

kable(eig_tabla, align = "c", col.names = c("Componente", "Eigenvalor", "% varianza", "% varianza acumulada")) %>% kable_styling(c("striped", "hover"), full_width = F)%>% scroll_box(width="100%", height="300px", fixed_thead = TRUE)
```

## Scree plot

```{r}
#| code-fold: true
#| warning: false

fviz_eig(PC_porcentaje, addlabels = TRUE)
```

## Coeficientes (Loadings)

```{r}
#| code-fold: true
PC_coef <-data.frame(PC_porcentaje$rotation)
kable(PC_coef, align = "c") %>% kable_styling(c("striped", "hover"), full_width = F)%>% scroll_box(width="100%", height="300px", fixed_thead = TRUE)
```

## Contribución variables

```{r}
#| code-fold: true
#| warning: false

fviz_pca_var(PC_porcentaje, col.var = "contrib", gradient.cols=c("#1627dc", "#ffb600", "#ff2e16"))
```

En este caso, la **Deuda Pública** y el **Gasto Corriente** están significativamente asociadas en la primera dimensión que en la segunda, esto sugiere que ambas variables están correlacionadas positivamente entre sí. Mientras que las dos restantes tambien están correlacionadas pero de manera negativa respecto a las primeras. 

## Contribución PC1

```{r}
#| code-fold: true
fviz_contrib(PC_porcentaje, "var", axes = 1)
```

## Contribución PC2

```{r}
#| code-fold: true
fviz_contrib(PC_porcentaje, "var", axes = 2)
```

## Proyecciones

::: panel-tabset
### Biplot

```{r}
#| code-fold: true
fviz_pca_biplot(PC_porcentaje,
                geom.ind = "point",
                fill.ind = egresos_wide$ABR_ENT,
                pointshape = 21 ,
                pointsize = 2,
                alpha.ind=0.6,
                col.var = "black",
                mean.point = FALSE,
                #palette= ,
                label= "var",
                repel = TRUE   
  )
```

La variabilidad entre el **Gasto Corriente** y la **Deuda Pública** entre los estados de México está en primer lugar asociada a la capacidad o voluntad de endeudamiento e inversión de los estados y en segundo lugar, a la composición de los egresos. Aquí podemos observar que hay diferencias significativas en las políticas fiscales y prioridades de gasto entre los diferentes estados. 

### Proyección

```{r}
#| code-fold: true
proy_scores <- fviz_pca_ind(PC_porcentaje,
             pointsize = 2,
             habillage = egresos_wide$ABR_ENT,
             mean.point = FALSE,
             #addEllipses = TRUE,
             label= "var",
            repel = TRUE 
  )
ggplotly(proy_scores)
```
:::
::::